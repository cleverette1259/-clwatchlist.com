document.addEventListener('DOMContentLoaded', () => {
    const PASS = 'Prince2beast';
    let library = JSON.parse(localStorage.getItem('cl_vF_links')) || [];
    let folders = JSON.parse(localStorage.getItem('cl_vF_folders')) || [];
    let openFolders = JSON.parse(localStorage.getItem('cl_vF_openFolders')) || [];
    let db;
    let currentURL = null;

    // 1. Database Setup (Version 2 for stability)
    const dbReq = indexedDB.open("VaultMediaDB", 2);
    dbReq.onupgradeneeded = (e) => {
        const database = e.target.result;
        if (!database.objectStoreNames.contains("media")) {
            database.createObjectStore("media");
        }
    };

    dbReq.onsuccess = (e) => { 
        db = e.target.result; 
        init(); 
    };

    function init() {
        updateHue(localStorage.getItem('vault_hue') || 0);
        // Load background from IndexedDB on startup
        const transaction = db.transaction("media", "readonly");
        const store = transaction.objectStore("media");
        store.get("currentBG").onsuccess = (e) => {
            if (e.target.result) {
                applyBG(e.target.result.data, e.target.result.type === 'v');
            }
        };
        render();
    }

    // 2. Background Handling (The "Save" Fix)
    function applyBG(data, isVid) {
        const vids = [document.getElementById('bg-video'), document.getElementById('lock-bg-video')];
        const imgs = [document.getElementById('bg-img'), document.getElementById('lock-bg-img')];
        
        // Revoke old URL to free memory
        if (currentURL) URL.revokeObjectURL(currentURL);

        // Hide all
        vids.forEach(v => { v.style.display = 'none'; v.classList.remove('bg-visible'); v.src = ""; });
        imgs.forEach(i => { i.style.display = 'none'; i.classList.remove('bg-visible'); i.style.backgroundImage = ""; });

        // Create new URL from Blob/File
        const source = (data instanceof Blob) ? (currentURL = URL.createObjectURL(data)) : data;

        if (isVid) {
            vids.forEach(v => { 
                v.src = source; 
                v.style.display = 'block'; 
                v.classList.add('bg-visible');
                v.play().catch(() => { /* Auto-play catch */ });
            });
        } else {
            imgs.forEach(i => { 
                i.style.backgroundImage = `url(${source})`; 
                i.style.display = 'block'; 
                i.classList.add('bg-visible'); 
            });
        }
    }

    window.triggerBG = () => { 
        const f = document.createElement('input'); 
        f.type = 'file'; 
        f.accept = 'image/*,video/*'; 
        f.onchange = (e) => { 
            const file = e.target.files[0];
            if (!file) return;
            const isV = file.type.includes('video'); 
            
            // Save the File (Blob) directly to DB
            const transaction = db.transaction("media", "readwrite");
            transaction.objectStore("media").put({ data: file, type: isV ? 'v' : 'i' }, "currentBG");
            transaction.oncomplete = () => applyBG(file, isV);
        }; 
        f.click(); 
    };

    // 3. UI Helpers
    function updateHue(h) {
        document.documentElement.style.setProperty('--accent-hue', h);
        localStorage.setItem('vault_hue', h);
    }
    document.getElementById('hue-slider').oninput = (e) => updateHue(e.target.value);

    window.toggleSidebarMenu = (e) => { e.stopPropagation(); const m = document.getElementById('sidebar-context'); m.style.display = (m.style.display === 'block') ? 'none' : 'block'; };
    window.closeAllMenus = () => { document.querySelectorAll('.context-menu').forEach(m => m.style.display = 'none'); };
    window.toggleMenu = (e, id) => { e.stopPropagation(); const m = document.getElementById(id); const s = m.style.display === 'block'; closeAllMenus(); if(!s) m.style.display = 'block'; };
    window.toggleFolder = (name) => {
        openFolders = openFolders.includes(name) ? openFolders.filter(f => f !== name) : [...openFolders, name];
        localStorage.setItem('cl_vF_openFolders', JSON.stringify(openFolders));
        render();
    };

    // 4. Item/Folder Logic
    function render() {
        const grid = document.getElementById('video-grid');
        grid.innerHTML = '';
        library.filter(i => !i.folder).forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            const fSub = folders.map(f => `<div class="menu-item" onclick="moveItem(${item.id}, '${f.name}')">${f.name}</div>`).join('');
            card.innerHTML = `
                <div class="card-dots" onclick="toggleMenu(event, 'm-${item.id}')">⋮</div>
                <div id="m-${item.id}" class="context-menu" style="top:25px; right:5px;">
                    <div class="menu-item" onclick="renameItem(${item.id})">Rename</div>
                    <div class="menu-item">Move To <span>▶</span><div class="submenu-inner">${fSub || 'No Folders'}</div></div>
                    <div class="menu-item" style="color:red;" onclick="deleteItem(${item.id})">Delete</div>
                </div>
                <div style="aspect-ratio:16/9; background:#111; margin-bottom:12px; overflow:hidden;"><img src="${item.thumb}" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='https://via.placeholder.com/320x180/111/fff?text=Link'"></div>
                <div style="font-size:10px; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-bottom:10px;">${item.label}</div>
                <button class="mist-btn" style="width:100%;" onclick="window.open('${item.url}','_blank')">LAUNCH</button>
            `;
            grid.appendChild(card);
        });

        const tabList = document.getElementById('folder-tab-list');
        tabList.innerHTML = '';
        folders.forEach(f => {
            const isOpen = openFolders.includes(f.name);
            const container = document.createElement('div');
            container.innerHTML = `
                <div class="folder-header">
                    <div class="folder-name-group" onclick="toggleFolder('${f.name}')">
                        <span style="font-size:8px; opacity:0.3;">${isOpen ? '▼' : '▶'}</span>
                        <span style="font-size:11px; font-weight:600; text-transform:uppercase;">${f.name}</span>
                    </div>
                    <div class="card-dots" style="position:relative; top:0; right:0;" onclick="toggleMenu(event, 'f-opt-${f.name}')">⋮</div>
                    <div id="f-opt-${f.name}" class="context-menu" style="right:0; margin-top:25px;">
                        <div class="menu-item" onclick="renameFolder('${f.name}')">Rename</div>
                        <div class="menu-item" style="color:red;" onclick="deleteFolder('${f.name}')">Delete</div>
                    </div>
                </div>
                <div class="folder-content ${isOpen ? 'open' : ''}">${renderFolderLinks(f.name)}</div>
            `;
            tabList.appendChild(container);
        });
    }

    function renderFolderLinks(fName) {
        const links = library.filter(i => i.folder === fName);
        if(!links.length) return '<div style="font-size:8px; opacity:0.2; text-align:center;">Empty</div>';
        const latestId = links.length ? links.reduce((p, c) => (p.movedAt > c.movedAt) ? p : c).id : null;
        return links.map(l => {
            const isFresh = (Date.now() - l.movedAt < 18000000) && l.id === latestId;
            return `
                <div class="folder-link-item">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:9px; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:140px;">
                            ${l.label}${isFresh ? '<span class="new-badge">NEW</span>' : ''}
                        </span>
                        <div class="card-dots" style="position:relative; top:0; right:0;" onclick="toggleMenu(event, 'f-m-${l.id}')">⋮</div>
                    </div>
                    <div id="f-m-${l.id}" class="context-menu" style="right:10px; margin-top:5px;">
                        <div class="menu-item" onclick="window.open('${l.url}','_blank')">Open</div>
                        <div class="menu-item" onclick="renameItem(${l.id})">Rename</div>
                        <div class="menu-item" onclick="moveItem(${l.id}, '')">Remove Folder</div>
                        <div class="menu-item" style="color:red;" onclick="deleteItem(${l.id})">Delete</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    window.moveItem = (id, fName) => { 
        const idx = library.findIndex(i => i.id === id); 
        if(idx !== -1) { library[idx].folder = fName; library[idx].movedAt = Date.now(); sync(); } 
    };
    window.renameFolder = (oldN) => { 
        const newN = prompt("New Folder Name:", oldN); 
        if(newN && newN !== oldN) { folders = folders.map(f => f.name === oldN ? {name: newN} : f); library.forEach(i => { if(i.folder === oldN) i.folder = newN; }); sync(); } 
    };
    window.renameItem = (id) => { 
        const i = library.find(item => item.id === id); 
        const n = prompt("Rename Link:", i.label); 
        if(n) { i.label = n; sync(); } 
    };
    window.deleteFolder = (n) => { folders = folders.filter(f => f.name !== n); library.forEach(i => {if(i.folder===n) i.folder='';}); sync(); };
    window.createNewFolder = () => { const n = prompt("Folder Name:"); if(n) { folders.push({name:n}); sync(); } };
    window.deleteItem = (id) => { library = library.filter(i => i.id !== id); sync(); };
    function sync() { localStorage.setItem('cl_vF_links', JSON.stringify(library)); localStorage.setItem('cl_vF_folders', JSON.stringify(folders)); render(); }

    document.getElementById('addCardBtn').onclick = async () => {
        const btn = document.getElementById('addCardBtn'); const input = document.getElementById('url-input');
        const url = input.value.trim(); if(!url) return;
        const clean = url.startsWith('http') ? url : `https://${url}`;
        btn.innerText = 'FETCHING...'; btn.disabled = true;
        try {
            const res = await fetch(`https://api.microlink.io?url=${encodeURIComponent(clean)}`);
            const data = await res.json();
            library.unshift({ id: Date.now(), label: data.data.title || clean, url: clean, thumb: data.data.image?.url || '', folder: "", movedAt: 0 });
            sync();
        } catch (e) { library.unshift({ id: Date.now(), label: clean, url: clean, thumb: '', folder: "", movedAt: 0 }); sync(); }
        btn.innerText = 'ADD TO VAULT'; btn.disabled = false; input.value = '';
    };

    document.getElementById('loginBtn').onclick = () => { 
        if(document.getElementById('password').value === PASS) {
            document.getElementById('lock-screen').classList.add('hidden');
            // Play the video background after unlocking (browsers like this)
            document.getElementById('bg-video').play().catch(() => {});
        }
    };
});
